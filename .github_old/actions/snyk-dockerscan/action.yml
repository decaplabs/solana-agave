name: Snyk Docker Scan
description: |
    Use Snyk service to scan the Docker image generated by this repository.
    Uses the github context for information- the repository name, and the GITHUB_SHA for the image tag.

inputs:
  SNYK_TOKEN:
    description: The Snyk service token for authentication and reporting. Get this from secrets.LSQ_SNYK_TOKEN.
    required: true

  registry-account-id:
    type: string
    description: The account ID of the decaplabs repository
    required: false
    default: 653832775139

  vars:
    description: from the caller workflow, pass this to function toJson(vars). See README.
    required: false

#secrets:
# We can't pass secrets to a composite action, only a called workflow.

runs:
  using: composite
  #env:
  #  GITHUB_SHA: ${{ fromJson(inputs.vars).GITHUB_SHA }}

  steps:
    # Snyk wasnâ€™t able to auto detect the base image, use `--file` option to get base image remediation advice.
    # Example: $ snyk container test $IMAGE:$TAG --file=path/to/Dockerfile
    - uses: actions/checkout@master

    - name: Get information
      id: varinfo
      shell: bash
      run: |
        #env    # debugging
        exec >> $GITHUB_OUTPUT
        GIT_REPO="${GITHUB_REPOSITORY##*/}"
        echo "GIT_REPO=$GIT_REPO"
        GITHUB_SHA_SHORT="$(git rev-parse --short HEAD)"
        echo "GITHUB_SHA_SHORT=$GITHUB_SHA_SHORT"
        echo -n 'IMAGE_PATH='
        echo "${{ inputs.registry-account-id }}.dkr.ecr.us-east-2.amazonaws.com/$GIT_REPO:$GITHUB_SHA_SHORT"


    - name: Log into ECR
      uses: ./.github/actions/ecr-login
      with:
        role-to-assume: arn:aws:iam::${{ inputs.registry-account-id }}:role/github-actions-role

      # Since docker login isn't available within the Snyk container, ensure the image is available on this host.
    - name: Make docker image available to the inner container
      shell: bash
      run: docker pull ${{ steps.varinfo.outputs.IMAGE_PATH }}

    - name: Snyk Docker scan
      uses: snyk/actions/docker@v1.0.0
      continue-on-error: true # https://snyk.io/blog/docker-image-scan-github-action/ - web archive
      env:
        SNYK_TOKEN: ${{ inputs.SNYK_TOKEN }}
        TEST_IMAGE: ${{ steps.varinfo.outputs.IMAGE_PATH }}
      #  GOPRIVATE: github.com/ecap-tech/*
      with:
        # -d for debug logs
        #command: -d test
        image: ${{ steps.varinfo.outputs.IMAGE_PATH }}
        # The module ignores this input, and doesn't generate this by default, contrary to the docs.
        args: --sarif-file-output=/github/workspace/snyk.sarif

    - name: Check for vuln
      id: hasvuln
      shell: bash
      run: |
        exec >> $GITHUB_OUTPUT
        echo HAS_VULN=
        jq -r < snyk.sarif '.runs[].results[].level' | grep -qv '^\(warning\|note\)$' && echo 'false' || echo 'true'

    # https://snyk.io/blog/docker-image-scan-github-action/ - web archive
    - name: Upload Snyk report as sarif
      continue-on-error: true # see below
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif: true
        category: snyk/dockerscan
        # We edited this one.
        sarif_file: snyk.sarif

    # This step because the upload step normally fails for non-unique category -- support ticket
    # https://support.snyk.io/s/case/500PU00000mg6QLYAY/snyk-needs-sarif-category-for-github-support
    - name: Check For Vuln
      if: steps.hasvuln.outputs.HAS_VULN
      shell: bash
      # fail the docker scan step.
      run: false
